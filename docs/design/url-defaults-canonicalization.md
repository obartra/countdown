# URL Defaults Canonicalization (proposal)

## Summary
Make the editor and viewer share a single definition of “defaults” for countdown URL parameters, so the editor can **omit default-valued params** from the query string while the viewer still renders the same result when those params are absent.

This likely aims to:
- Reduce noisy/long URLs generated by the editor.
- Prevent “default drift” where editor-only defaults differ from viewer defaults over time.
- Ensure URLs are canonical and stable (e.g., default theme colors don’t need to be redundantly encoded).

## Current State (evidence)
- **Viewer reads params from the URL** via `parseParamsFromSearch` (`src/countdown.ts`) and uses the derived values to render the countdown (`src/hooks/useCountdownViewModel.ts`, `src/App.tsx`).
  - `completeText` defaults to `"Time is up!"` when the `complete` param is missing (`src/countdown.ts`).
  - Colors are derived by `deriveColors(bgcolor, color)`, which:
    - Uses a default theme when both are missing.
    - Infers the missing color for contrast when only one is provided (`src/countdown.ts`).
  - The derived colors are applied to the page via `document.body.style.backgroundColor` / `color` (`src/hooks/useCountdownViewModel.ts`).
- **Editor mirrors URL params into form state** and keeps the URL updated as you edit:
  - Form → query string serialization is done in `buildSearchParams` (`src/EditPage.tsx`).
  - The edit view rewrites `window.location.search` via `history.replaceState` whenever the form changes (`src/EditPage.tsx`).
- **Some defaults are already “URL-omitted” in the editor**:
  - The editor treats the default complete message as “empty input”: `params.completeText === "Time is up!" ? "" : ...`, and `buildSearchParams` only emits `complete` if the field is non-empty (`src/EditPage.tsx`).
  - This works only because the viewer also defaults missing `complete` to `"Time is up!"` (`src/countdown.ts`).
- **Colors are currently always written into the URL by the editor**, even when they were not provided (and even when they match the default theme):
  - `parseParamsFromSearch` always returns *derived* `backgroundColor`/`textColor` (`src/countdown.ts`).
  - The editor initializes `form.bgcolor`/`form.color` from those derived values (`src/EditPage.tsx`), so they are almost never empty.
  - `buildSearchParams` emits `bgcolor` and `color` whenever the fields are non-empty (`src/EditPage.tsx`).
  - The UI explicitly states this behavior: “URLs still include `bgcolor` and `color`.” (`src/EditPage.tsx`).
- There is **duplication risk** for defaults and default-like behavior:
  - The string `"Time is up!"` appears in multiple places (`src/countdown.ts`, `src/EditPage.tsx`, plus tests).
  - Default theme selection is implicit via `DEFAULT_THEME_KEY` in `src/themes.ts` and `deriveColors` in `src/countdown.ts`.

## Constraints (architecture/tooling/deployment)
- **URL query params are the primary contract** for sharing/embedding (`README.md`, `src/countdown.ts`).
- **No router**: the SPA toggles between viewer/editor based on path (`/edit`) and query params, and on whether the time is valid (`src/main.tsx`).
- **Editor is already URL-sync’d live** via `history.replaceState` (no “apply” button) (`src/EditPage.tsx`).
- **Base path matters**: share/edit links are built using `import.meta.env.BASE_URL` (`src/EditPage.tsx`, `src/components/ui/countdown-header.tsx`). Any canonicalization logic must not assume the app is always hosted at `/`.
- **Color inference uses DOM APIs** (`document.createElement("canvas")`) in `deriveColors` (`src/countdown.ts`), which is fine for the browser and `jsdom` tests, but is not “pure” in a Node-only environment.

## Intent / Problem (inferred)
The idea likely targets URL cleanliness and correctness:
- Today, simply opening the editor with a URL that omits some params can cause the editor to **rewrite the URL with derived/default values** (notably `bgcolor`/`color`) (`src/EditPage.tsx`).
- That makes URLs longer and less semantically meaningful (“did the user pick these colors, or are they defaults?”).
- The editor already demonstrates a pattern for canonicalization (omit `complete` when it’s the default), but it’s not generalized across parameters.
- Duplicated defaults (e.g., `"Time is up!"`) increase the chance that viewer/editor behavior diverges if a default changes later.

## Proposed Direction (default)
Introduce a small shared utility (no new dependencies) that:
1) Centralizes default values for **all URL parameters** (including `DEFAULT_COMPLETE_TEXT` and default theme colors).
2) Defines canonicalization + serialization rules for URL params.
3) Separates what the editor **displays in inputs** from what it **writes to the URL**, so the URL can be canonicalized on every change without rewriting user-entered values in the controls.

### Decisions (confirmed)
These are product decisions captured from discussion (i.e., not implied by repo code):
1) **Never emit defaults**: if a value matches defaults, omit it from the URL (including `bgcolor`/`color` matching the default theme pair).
2) **One place defines defaults**: define defaults for all parameters in a shared module and use those definitions consistently across parsing, preview, and URL serialization.
3) **Compare against defaults after canonicalization**: comparisons use canonical forms (e.g., trim text, normalize colors) rather than raw user input strings.
4) **Canonicalize on every change**: the URL updates to the canonicalized version on every form change (including each keystroke for text inputs).
5) **Canonicalization does not rewrite inputs**: the editor should not “snap” input values to canonical forms (e.g., `#fff` should not be rewritten to `#ffffff` in the input, and default values should not disappear from inputs).
6) **Explicit-equals-default is still omitted**: if a user types a value equal to the default, canonicalization still removes it from the URL (after canonicalization; see (3)), while keeping the input value intact (see (5)).
7) **Partial color overrides are correct**: preserve “only `bgcolor`” or “only `color`” if that’s the intended override; do not normalize to always emit both.
8) **Default theme is stable**: omitting default theme colors is acceptable because defaults are not expected to change over time.
9) **Canonicalize on load everywhere**: regardless of whether the user lands on viewer or editor, the URL is canonicalized on initial load (via `history.replaceState`) before it is treated as the source of truth.
10) **Preview always renders canonical params**: the editor preview must never render from non-canonical values; it should render from the same canonicalized params the viewer uses.

### A concrete default behavior to aim for
- Treat URL params as a “patch” over defaults:
  - Missing params mean “use default rendering.”
  - Editor should only emit a param if the user has set a non-default override.
- Canonicalization rules (based on decisions above):
  - `complete`: omit when it equals the default complete text (today’s behavior), and use the same shared constant in viewer + editor.
  - `bgcolor` / `color`:
    - Do **not** write inferred counterparts back to the URL (e.g., if URL only has `bgcolor`, keep only `bgcolor`).
    - Omit `bgcolor` if it matches the background that would be used when `bgcolor` is absent (given the other inputs).
    - Omit `color` if it matches the text color that would be used when `color` is absent (given the other inputs).
    - As a result, when both match the default theme pair, neither should appear in the URL.
  - Other string params (`title`, `description`, `footer`, `image`): omit when empty/whitespace (today’s behavior).
  - Time: continue to canonicalize to `time` and drop the `date` alias when writing URLs (already happens in the editor via `buildSearchParams`, and in the viewer helper submit) (`src/countdown.ts`, `src/EditPage.tsx`, `src/hooks/useCountdownViewModel.ts`).

### Notes on “defaults” for colors
In this repo, “defaults” for `bgcolor`/`color` are not purely constant values:
- If both are missing, `deriveColors` falls back to the default theme (`src/countdown.ts`, `src/themes.ts`).
- If exactly one is provided, the other is derived for contrast (`src/countdown.ts`).

So canonicalization needs to compare against the **resolved default given the current overrides**, not only against the default theme pair.

### Notes on canonicalizing color values
Normalize equivalent color representations before comparing against defaults and when producing canonical URL output:
- Normalize hex casing and length (`#fff` ⇢ `#ffffff`, uppercase ⇢ lowercase).
- Treat CSS named colors as equivalent to their computed hex value (e.g., `white` ⇢ `#ffffff`), using the same DOM/canvas-based approach already used by `deriveColors` (`src/countdown.ts`).

Important: canonicalization should affect the **URL value**, not the input control value (see decision (5)).

### Likely shape of a shared utility
- File: something like `src/countdownUrl.ts` or `src/lib/countdownUrl.ts` (pure TS; no React import).
- Exports:
  - `DEFAULT_COMPLETE_TEXT`
  - `DEFAULTS` (a single object describing all defaults)
  - `canonicalizeCountdownParams(raw)` (or per-param canonicalizers)
  - `buildCountdownSearchParams(input)` (or `serializeCountdownParamsToSearchParams`)
  - Potentially `parseCountdownSearchParams(search)` if we want a single source for both parse + serialize rules (optional; may be too invasive initially).
- The editor would effectively work with three “views” of parameters:
  - **Display params**: values shown in inputs (may include defaults; may keep user-entered variants like `#fff`).
  - **Canonical params**: normalized values used for URL writing + default comparison (e.g., `#fff` ⇒ `#ffffff`).
  - **Rendered params**: resolved values used by the preview (defaults applied + derived values like inferred contrast colors).

Preview should be derived from **canonical params only** (or by parsing the canonicalized URL), so it cannot diverge from what the viewer would render for the same URL.

## Alternatives Considered
- **Keep emitting explicit `bgcolor`/`color` always** (current behavior).
  - Pros: shared URLs are fully explicit and resilient to future default/algorithm changes.
  - Cons: URLs are longer and the editor injects values the user didn’t explicitly choose.
- **Add a `theme` param** and emit only a theme key for default themes.
  - Pros: shorter URLs and more semantic than raw hex codes.
  - Cons: changes the URL contract (new param); requires migration strategy; viewer/editor would need to support both.
- **Only canonicalize on “Copy URL”** (not live).
  - Pros: avoids surprising URL rewrites during editing; keeps “what you loaded” intact.
  - Cons: canonical URL differs from the URL in the address bar while editing; may be confusing.

## Risks / Unknowns
- **Changing defaults later changes old URLs** if defaults are omitted.
  - This is already true for `complete` today; extending it to theme colors increases the surface area.
  - Decision: default theme is expected to be stable, but if it ever changes this becomes a breaking behavior change for previously-canonical URLs.
- **Derived-vs-explicit ambiguity**: user intent is lost when explicit-equals-default is omitted (decision: omit anyway for consistency/canonical URLs).
- **Input vs URL mismatch**: inputs can display default values (or non-canonical but valid variants) while the URL omits/normalizes them. This is intended, but may confuse users unless the UI clearly communicates that the URL is “canonical overrides” while the preview reflects the full rendered result.
- **URL churn**: canonicalization must be stable so `replaceState` doesn’t oscillate between two representations.
- **Conflicting prior direction**: an existing design doc states “URLs still include `bgcolor` and `color`.” (`docs/design/theme-presets-with-legacy-colors.md`, `src/EditPage.tsx`). If we change this, we should reconcile/update that doc and any UI copy/tests that encode the old expectation.

## Open Questions
None at this time; the initial canonicalization rules and timing decisions are captured above. If implementation reveals UX issues (e.g., keystroke-level URL updates feel too noisy or have perf impact), revisit in a follow-up doc/PR brief.

## High-Level Implementation Plan (PR-sized steps)
1) **Doc + contract**: Add/confirm canonicalization rules (this doc), including how “defaults” are computed for `bgcolor`/`color`.
2) **Shared defaults + canonicalization module**: Introduce a small utility exporting shared defaults (for all params), canonicalizers (trim, normalize colors), and URL serialization helpers. Add unit tests covering canonicalization behavior and equivalence (e.g., `#fff` vs `#ffffff`).
3) **Viewer alignment**: Update `parseParamsFromSearch` to use shared defaults/constants (minimize duplicated literals) (`src/countdown.ts`), and canonicalize the URL on initial load so the viewer always renders from canonical params.
4) **Editor display-vs-canonical split**:
   - Initialize input values from raw URL values when present (to preserve valid variants), otherwise initialize from rendered defaults (so the editor can prepopulate fields even when the URL omits defaults).
   - Use the shared serialization helper to build canonical query strings, omitting defaults and avoiding inferred params.
   - Ensure the editor preview renders from canonical params (or from parsing the canonical URL), not directly from display params.
   - Keep URL updates on every change, but ensure canonicalization never rewrites input control values (preserve the user-entered representation in the controls).
   - Update UI copy (“URLs still include `bgcolor` and `color`.”) if behavior changes.
5) **Tests + regression coverage**:
   - Update/extend `src/EditPage.test.tsx` and add a targeted test ensuring default-valued fields are omitted from `window.location.search` while the preview remains unchanged.
   - Add a small integration test proving a canonicalized URL renders identically in the viewer (`src/App.test.tsx`).
